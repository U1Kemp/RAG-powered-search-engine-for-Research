<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>RAG-Powered Chatbot for Research Papers</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4; /* Light mode background */
            color: #333; /* Light mode text color */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: #1e1e1e; /* Dark mode background */
            color: #d4d4d4; /* Dark mode text color */
        }

        #chat-container {
            width: 80%;
            max-width: 800px;
            margin: 0 auto;
        }

        #config {
            margin-bottom: 20px;
            background-color: #fff; /* Light mode config background */
            color: #333; /* Light mode config text color */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        body.dark-mode #config {
            background-color: #252525; /* Dark mode config background */
            color: #d4d4d4; /* Dark mode config text color */
            border-color: #555;
        }

        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 400px;
            overflow-y: scroll;
            background: #f9f9f9; /* Light mode messages background */
            color: #333; /* Light mode messages text color */
            border-radius: 8px;
        }

        body.dark-mode #messages {
            border-color: #555;
            background: #2c2c2c; /* Dark mode messages background */
            color: #d4d4d4; /* Dark mode messages text color */
        }

        .message {
            margin: 10px 0;
        }

        .user {
            text-align: right;
            background: #e0f7fa; /* Light mode user background */
            color: #333; /* Light mode user text color */
            padding: 8px;
            border-radius: 5px;
            display: inline-block;
            max-width: 80%;
            word-break: break-word;
        }

        body.dark-mode .user {
            background: #42a5f5; /* Dark mode user background */
            color: #fff; /* Dark mode user text color */
        }

        .assistant {
            text-align: left;
            background: #f1f8e9; /* Light mode assistant background */
            color: #333; /* Light mode assistant text color */
            padding: 8px;
            border-radius: 5px;
            display: inline-block;
            max-width: 80%;
            word-break: break-word;
        }

        body.dark-mode .assistant {
            background: #4caf50; /* Dark mode assistant background */
            color: #fff; /* Dark mode assistant text color */
        }

        .citation {
            font-size: 0.9em;
            color: #555; /* Light mode citation color */
            margin-top: 5px;
        }

        body.dark-mode .citation {
            color: #bbb; /* Dark mode citation color */
        }

        input[type="text"] {
            width: calc(70% - 18px); /* Adjust for padding */
            padding: 8px;
            border: 1px solid #ccc; /* Light mode input border */
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff; /* Light mode input background */
            color: #333; /* Light mode input text color */
        }

        body.dark-mode input[type="text"] {
            border-color: #555;
            background-color: #333; /* Dark mode input background */
            color: #d4d4d4; /* Dark mode input text color */
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff; /* Light mode button background */
            color: white; /* Light mode button text color */
            cursor: pointer;
        }

        body.dark-mode button {
            background-color: #0056b3; /* Dark mode button background */
        }

        button:hover {
            background-color: #0056b3; /* Light mode button hover background */
        }

        body.dark-mode button:hover {
            background-color: #003d80; /* Dark mode button hover background */
        }

        label {
            display: inline-block;
            margin-bottom: 5px;
            color: #333; /* Light mode label color */
        }

        body.dark-mode label {
            color: #d4d4d4; /* Dark mode label color */
        }

        select {
            padding: 8px;
            border: 1px solid #ccc; /* Light mode select border */
            border-radius: 4px;
            background-color: #fff; /* Light mode select background */
            color: #333; /* Light mode select text color */
            box-sizing: border-box;
        }

        body.dark-mode select {
            border-color: #555;
            background-color: #333; /* Dark mode select background */
            color: #d4d4d4; /* Dark mode select text color */
        }
    </style>
</head>
<body>
<div id="chat-container">
    <h2>RAG-Powered Chatbot for Research Papers</h2>
    <button id="toggle-dark-mode">Toggle Dark Mode</button>
    <div id="config">
        <label for="topics">Topics (comma separated):</label>
        <input type="text" id="topics" placeholder="e.g., diffusion models, reinforcement learning" value="Deep Learning, NLP">
        <br>
        <br>
        <input type="checkbox" id="use_wikipedia" checked> Use Wikipedia for context
        <br>
        <label>ArXiv Fetch Options for context</label><br>
        <input type="checkbox" id="fetch_most_relevant" checked> Fetch Most Relevant<br>
        <input type="checkbox" id="fetch_most_recent"> Fetch Most Recent<br>
        <br>
        <label for="arxiv_subject" class="form-label">Subject Area</label>
        <select class="form-select" id="arxiv_subject">
            <option value="">All Subjects</option>
            {% for subject in subjects %}
            <option value="{{ subject }}">{{ subject }}</option>
            {% endfor %}
        </select>
        <br>
        <label for="arxiv_subtopic" class="form-label">Subtopic</label>
        <select class="form-select" id="arxiv_subtopic" disabled>
            <option value="">Select Subject First</option>
        </select>
        <br>
        <button id="set-config">Set Configuration</button>
    </div>
    <div id="messages"></div>
    <form id="chat-form" style="margin-top: 20px;">
        <input type="text" id="prompt" autocomplete="off" placeholder="Type your message..." required>
        <button type="submit">Send</button>
    </form>
</div>
<script>
    const darkModeToggle = document.getElementById('toggle-dark-mode');
    const body = document.body;

    darkModeToggle.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    });

    // Check for saved dark mode preference
    const darkModePreference = localStorage.getItem('darkMode');
    if (darkModePreference === 'true') {
        body.classList.add('dark-mode');
    }

    let chatStateInitialized = false;
    // Scroll chat to bottom
    function scrollChat() {
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
    }

     // Load subtopics when subject is selected
     document.getElementById('arxiv_subject').addEventListener('change', async function() {
         const subject = this.value;
         const subtopicSelect = document.getElementById('arxiv_subtopic');

         if (subject) {
             try {
                 const response = await fetch('/get_subtopics', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({ subject: subject }),
                 });

                 const subtopics = await response.json();

                 // Clear and populate subtopic dropdown
                 subtopicSelect.innerHTML = '<option value="">All Subtopics</option>';
                 subtopics.forEach(subtopic => {
                     const option = document.createElement('option');
                     option.value = subtopic;
                     option.textContent = subtopic;
                     subtopicSelect.appendChild(option);
                 });

                 subtopicSelect.disabled = false;
             } catch (error) {
                 console.error('Error:', error);
             }
         } else {
             // Reset subtopic dropdown
             subtopicSelect.innerHTML = '<option value="">Select Subject First</option>';
             subtopicSelect.disabled = true;
         }
     });

    // Set configuration by calling /init
    document.getElementById("set-config").addEventListener("click", function() {
        const topics = document.getElementById("topics").value.split(",").map(t => t.trim()).filter(t => t !== "");
        const use_wikipedia = document.getElementById("use_wikipedia").checked;
        const fetch_most_relevant = document.getElementById("fetch_most_relevant").checked;
        const fetch_most_recent = document.getElementById("fetch_most_recent").checked;
        const arxiv_subject = document.getElementById("arxiv_subject").value.trim();
        const arxiv_subtopic = document.getElementById("arxiv_subtopic").value.trim();
        if (topics.length === 0) {
            alert("Please enter at least one topic.");
            return;
        }
        fetch("/init", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ topics, use_wikipedia, fetch_most_relevant, fetch_most_recent, arxiv_subject, arxiv_subtopic })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  chatStateInitialized = true;
                  document.getElementById("messages").innerHTML = "";
                  appendMessage("system", `Configuration set: Topics: <strong>${topics.join(", ")}</strong>`);
              }
          });
    });

    // Append messages to chat
    function appendMessage(sender, html) {
        const messages = document.getElementById("messages");
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", sender);
        msgDiv.innerHTML = html;
        messages.appendChild(msgDiv);
        scrollChat();
        return msgDiv;
    }

    document.getElementById("chat-form").addEventListener("submit", function(e) {
        e.preventDefault();
        if (!chatStateInitialized) {
            alert("Please set the configuration first.");
            return;
        }
        const promptInput = document.getElementById("prompt");
        const prompt = promptInput.value.trim();
        if (!prompt) return;
        appendMessage("user", `<strong>User:</strong> ${prompt}`);
        promptInput.value = "";

        const assistantMsg = appendMessage("assistant",
            `<strong>Assistant:</strong>
             <div class="assistant-status" style="color: gray;"></div>
             <div class="response-content"></div>
             <div class="citations"></div>`);

        const eventSource = new EventSource("/chat?prompt=" + encodeURIComponent(prompt));
        eventSource.addEventListener("status", function(event) {
            const statusEl = assistantMsg.querySelector(".assistant-status");
            if (statusEl) {
                statusEl.innerHTML = event.data;
                scrollChat();
            }
        });
        eventSource.addEventListener("clearStatus", function(event) {
            const statusEl = assistantMsg.querySelector(".assistant-status");
            if (statusEl) {
                statusEl.innerHTML = "";
            }
        });
        eventSource.onmessage = function(event) {
            const responseContent = assistantMsg.querySelector(".response-content");
            responseContent.innerHTML += event.data;
            scrollChat();
        };
        eventSource.addEventListener("citation", function(event) {
            const citationsDiv = assistantMsg.querySelector(".citations");
            const citationElem = document.createElement("div");
            citationElem.classList.add("citation");
            citationElem.innerHTML = event.data;
            citationsDiv.appendChild(citationElem);
            scrollChat();
        });
        eventSource.onerror = function(event) {
            eventSource.close();
        };
        eventSource.addEventListener("end", function() {
            eventSource.close();
        });
    });
</script>
</body>
</html>